<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paymium E2E - Allure Reports</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      min-height: 100vh
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem
    }

    .header {
      text-align: center;
      margin-bottom: 1.5rem
    }

    .header h1 {
      font-size: 1.6rem;
      color: #1a1a2e;
      margin-bottom: .3rem
    }

    .header p {
      color: #666;
      font-size: .9rem
    }

    /* â”€â”€â”€ Loading / Error â”€â”€â”€ */
    .loading {
      text-align: center;
      padding: 3rem;
      color: #666
    }

    .loading .spinner {
      display: inline-block;
      width: 28px;
      height: 28px;
      border: 3px solid #e0e0e0;
      border-top-color: #1565c0;
      border-radius: 50%;
      animation: spin .7s linear infinite;
      margin-bottom: .8rem
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .error-msg {
      text-align: center;
      padding: 2rem;
      color: #c62828;
      background: #ffebee;
      border-radius: 10px;
      margin: 1rem 0
    }

    /* â”€â”€â”€ Toolbar â”€â”€â”€ */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: .6rem;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0 .25rem
    }

    .search-box {
      flex: 1 1 280px;
      position: relative
    }

    .search-box input {
      width: 100%;
      padding: 9px 14px 9px 36px;
      border: 1px solid #d0d5dd;
      border-radius: 8px;
      font-size: .88rem;
      background: #fff;
      transition: border .2s
    }

    .search-box input:focus {
      outline: none;
      border-color: #1565c0;
      box-shadow: 0 0 0 3px rgba(21, 101, 192, .12)
    }

    .search-box svg {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: #999;
      pointer-events: none
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
      align-items: center
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: .3rem
    }

    .filter-group label {
      font-size: .78rem;
      color: #666;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .03em;
      white-space: nowrap
    }

    .filter-group select {
      padding: 6px 28px 6px 10px;
      border: 1px solid #d0d5dd;
      border-radius: 8px;
      font-size: .84rem;
      background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' fill='none' stroke='%23666' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 8px center;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
      transition: border .2s
    }

    .filter-group select:focus {
      outline: none;
      border-color: #1565c0
    }

    .filter-btn {
      padding: 6px 14px;
      border: 1px solid #d0d5dd;
      border-radius: 8px;
      font-size: .82rem;
      background: #fff;
      cursor: pointer;
      color: #666;
      font-weight: 500;
      transition: all .15s
    }

    .filter-btn:hover {
      border-color: #1565c0;
      color: #1565c0
    }

    .filter-btn.active {
      background: #1565c0;
      color: #fff;
      border-color: #1565c0
    }

    .count {
      font-size: .78rem;
      color: #999;
      margin-left: auto;
      white-space: nowrap
    }

    /* â”€â”€â”€ Table â”€â”€â”€ */
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .06);
      overflow: hidden
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    thead th {
      background: #1a1a2e;
      color: #fff;
      padding: 12px 16px;
      text-align: left;
      font-size: .82rem;
      font-weight: 600;
      letter-spacing: .04em;
      text-transform: uppercase;
      cursor: pointer;
      user-select: none;
      white-space: nowrap
    }

    thead th:hover {
      background: #2a2a4e
    }

    thead th .sort-arrow {
      display: inline-block;
      margin-left: 4px;
      font-size: .7rem;
      opacity: .5
    }

    thead th.sorted .sort-arrow {
      opacity: 1
    }

    tbody td {
      padding: 10px 16px;
      border-bottom: 1px solid #f0f0f0;
      font-size: .88rem;
      vertical-align: middle
    }

    tbody tr:last-child td {
      border-bottom: none
    }

    tbody tr:hover td {
      background: #f8f9ff
    }

    tbody tr.hidden {
      display: none
    }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: .78rem;
      font-weight: 600;
      white-space: nowrap
    }

    .pass {
      background: #e8f5e9;
      color: #2e7d32
    }

    .fail {
      background: #ffebee;
      color: #c62828
    }

    .env {
      background: #e3f2fd;
      color: #1565c0
    }

    .job {
      background: #f3e5f5;
      color: #7b1fa2
    }

    a.rlink {
      color: #1565c0;
      text-decoration: none;
      font-weight: 500
    }

    a.rlink:hover {
      text-decoration: underline
    }

    a.ci {
      color: #999;
      font-size: .78rem;
      text-decoration: none
    }

    a.ci:hover {
      color: #1565c0
    }

    .foot {
      text-align: center;
      margin-top: 1.5rem;
      color: #aaa;
      font-size: .78rem
    }

    .empty-row td {
      padding: 3rem;
      text-align: center;
      color: #aaa;
      font-style: italic
    }

    /* â”€â”€â”€ Stats Preview Bar â”€â”€â”€ */
    .stats-bar {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .06);
      margin-bottom: 1rem;
      overflow: hidden
    }

    .stats-bar-header {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      gap: 12px;
      cursor: pointer;
      user-select: none
    }

    .stats-bar-header:hover {
      background: #fafbff
    }

    .stats-bar-metrics {
      display: flex;
      gap: 18px;
      flex: 1;
      flex-wrap: wrap
    }

    .stats-bar-metric {
      display: flex;
      align-items: baseline;
      gap: 4px;
      font-size: .82rem
    }

    .stats-bar-metric .val {
      font-weight: 700;
      color: #1a1a2e
    }

    .stats-bar-metric .lbl {
      color: #888
    }

    .stats-bar-actions {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .stats-bar-link {
      font-size: .8rem;
      color: #1565c0;
      text-decoration: none;
      font-weight: 500;
      white-space: nowrap
    }

    .stats-bar-link:hover {
      text-decoration: underline
    }

    .stats-expand-btn {
      background: none;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: .72rem;
      color: #888;
      transition: all .15s
    }

    .stats-expand-btn:hover {
      border-color: #1565c0;
      color: #1565c0
    }

    .stats-bar-body {
      border-top: 1px solid #f0f0f0;
      padding: 12px 16px;
      display: none
    }

    .stats-bar-body.open {
      display: block
    }

    /* â”€â”€â”€ Mini Charts Row â”€â”€â”€ */
    .mini-charts-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 4px
    }

    .mini-chart-title {
      font-size: .68rem;
      color: #888;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .03em;
      margin-bottom: 2px
    }

    .mini-chart-svg {
      width: 100%;
      height: 75px
    }

    .mini-chart-svg svg {
      width: 100%;
      height: 100%
    }

    .mini-chart-svg .bar-group:hover rect {
      filter: brightness(.88)
    }

    .mini-charts-footer {
      display: flex;
      justify-content: space-between;
      font-size: .68rem;
      color: #aaa;
      margin-top: 3px
    }

    .mini-legend {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .mini-legend span {
      display: flex;
      align-items: center;
      gap: 2px
    }

    .mini-legend .ml-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 2px
    }

    @media(max-width:640px) {
      .mini-charts-row {
        grid-template-columns: repeat(2, 1fr)
      }

      .mini-chart-svg {
        height: 55px
      }
    }

    @media(max-width:768px) {
      .container {
        padding: 1rem .5rem
      }

      .toolbar {
        flex-direction: column
      }

      .search-box {
        flex: 1 1 100%
      }

      .count {
        margin-left: 0;
        margin-top: .3rem
      }

      thead th,
      tbody td {
        padding: 8px 10px;
        font-size: .78rem
      }

      .header h1 {
        font-size: 1.3rem
      }

      .stats-bar-metrics {
        gap: 10px
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Paymium E2E - Allure Reports</h1>
      <p>Test reports deployed from GitLab CI/CD to GitHub Pages</p>
    </div>

    <!-- Stats Preview Bar (loaded from stats-history.json) -->
    <div class="stats-bar" id="statsBar" style="display:none">
      <div class="stats-bar-header" id="statsToggle">
        <span style="font-size:1.1rem">ðŸ“Š</span>
        <div class="stats-bar-metrics">
          <div class="stats-bar-metric"><span class="val" id="sRuns7d">â€”</span><span class="lbl">runs (7d)</span></div>
          <div class="stats-bar-metric"><span class="val" id="sPass7d">â€”</span><span class="lbl">pass rate</span></div>
          <div class="stats-bar-metric"><span class="val" id="sRuns30d">â€”</span><span class="lbl">runs (30d)</span>
          </div>
          <div class="stats-bar-metric"><span class="val" id="sPass30d">â€”</span><span class="lbl">pass rate</span></div>
        </div>
        <div class="stats-bar-actions">
          <a href="stats.html" class="stats-bar-link" onclick="event.stopPropagation()">Dashboard â†’</a>
          <button class="stats-expand-btn" id="statsExpandBtn" title="Toggle chart">â–¼</button>
        </div>
      </div>
      <div class="stats-bar-body open" id="statsBody">
        <div class="mini-charts-row">
          <div class="mini-chart">
            <div class="mini-chart-title">Runs by Platform</div>
            <div class="mini-chart-svg" id="miniPlatformRuns"></div>
          </div>
          <div class="mini-chart">
            <div class="mini-chart-title">Runs by Env</div>
            <div class="mini-chart-svg" id="miniEnvRuns"></div>
          </div>
          <div class="mini-chart">
            <div class="mini-chart-title">Pass Rate %</div>
            <div class="mini-chart-svg" id="miniPassRate"></div>
          </div>
          <div class="mini-chart">
            <div class="mini-chart-title">Avg Tests/Run</div>
            <div class="mini-chart-svg" id="miniAvgTests"></div>
          </div>
        </div>
        <div class="mini-charts-footer">
          <div class="mini-legend" id="miniLegend"></div>
          <span id="miniDateRange"></span>
        </div>
      </div>
    </div>

    <!-- Toolbar: Search + Filters -->
    <div class="toolbar">
      <div class="search-box">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input type="text" id="searchInput" placeholder="Search by date, branch, job, environment..."
          autocomplete="off">
      </div>
      <div class="filters">
        <div class="filter-group">
          <label>Env</label>
          <select id="filterEnv">
            <option value="">All</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Job</label>
          <select id="filterJob">
            <option value="">All</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Status</label>
          <select id="filterStatus">
            <option value="">All</option>
            <option value="pass">All passed</option>
            <option value="fail">Has failures</option>
          </select>
        </div>
        <button class="filter-btn" id="btnReset" title="Reset all filters">Clear</button>
      </div>
      <span class="count" id="rowCount"></span>
    </div>

    <div class="card">
      <table id="reportsTable">
        <thead>
          <tr>
            <th data-col="0">Date (UTC) <span class="sort-arrow">â–¼</span></th>
            <th data-col="1">Env <span class="sort-arrow">â–¼</span></th>
            <th data-col="2">Branch <span class="sort-arrow">â–¼</span></th>
            <th data-col="3">Job <span class="sort-arrow">â–¼</span></th>
            <th data-col="4">Results <span class="sort-arrow">â–¼</span></th>
            <th data-col="5">Report</th>
            <th data-col="6">CI</th>
          </tr>
        </thead>
        <tbody id="reportsBody">
        </tbody>
      </table>
    </div>
    <div id="loadingIndicator" class="loading">
      <div class="spinner"></div>
      <div>Loading reports...</div>
    </div>
    <div class="foot" id="footerInfo"></div>
  </div>

  <script>
    (function () {
      /* â”€â”€â”€ DOM references â”€â”€â”€ */
      var table = document.getElementById('reportsTable');
      var tbody = document.getElementById('reportsBody');
      var searchInput = document.getElementById('searchInput');
      var filterEnv = document.getElementById('filterEnv');
      var filterJob = document.getElementById('filterJob');
      var filterStatus = document.getElementById('filterStatus');
      var btnReset = document.getElementById('btnReset');
      var rowCount = document.getElementById('rowCount');
      var loadingEl = document.getElementById('loadingIndicator');
      var footerEl = document.getElementById('footerInfo');

      var allReports = [];
      var rows = [];

      /* â”€â”€â”€ Format timestamp: "2026-02-18_143000" â†’ "2026-02-18 14:30:00" â”€â”€â”€ */
      function formatTimestamp(ts) {
        if (!ts) return '-';
        var m = ts.match(/^(\d{4}-\d{2}-\d{2})_(\d{2})(\d{2})(\d{2})$/);
        if (!m) return ts;
        return m[1] + ' ' + m[2] + ':' + m[3] + ':' + m[4];
      }

      /* â”€â”€â”€ Escape HTML â”€â”€â”€ */
      function esc(s) {
        var d = document.createElement('div');
        d.textContent = s || '';
        return d.innerHTML;
      }

      /* â”€â”€â”€ Build one table row from a report entry â”€â”€â”€ */
      function buildRow(r) {
        var tr = document.createElement('tr');
        var hasFail = r.failed > 0;
        tr.dataset.env = r.environment || '';
        tr.dataset.job = r.job || '';
        tr.dataset.fail = hasFail ? '1' : '0';

        /* Date */
        var tdDate = document.createElement('td');
        tdDate.textContent = formatTimestamp(r.timestamp);
        tr.appendChild(tdDate);

        /* Env */
        var tdEnv = document.createElement('td');
        tdEnv.innerHTML = '<span class="badge env">' + esc(r.environment) + '</span>';
        tr.appendChild(tdEnv);

        /* Branch */
        var tdBranch = document.createElement('td');
        var branchText = r.branch || '';
        var e2eText = r.e2eBranch || '';
        if (e2eText && e2eText !== branchText) {
          tdBranch.innerHTML = esc(branchText) + ' <span style="opacity:.55;font-size:.85em">(e2e: ' + esc(e2eText) + ')</span>';
          tdBranch.title = branchText + ' (e2e: ' + e2eText + ')';
        } else {
          tdBranch.textContent = branchText;
          tdBranch.title = branchText;
        }
        tr.appendChild(tdBranch);

        /* Job */
        var tdJob = document.createElement('td');
        tdJob.innerHTML = '<span class="badge job">' + esc(r.job) + '</span>';
        tr.appendChild(tdJob);

        /* Results */
        var tdResults = document.createElement('td');
        var statusHtml = '<span class="badge pass">' + (r.passed || 0) + ' passed</span>';
        if (hasFail) {
          statusHtml += ' <span class="badge fail">' + r.failed + ' failed</span>';
        }
        tdResults.innerHTML = statusHtml;
        tr.appendChild(tdResults);

        /* Report link */
        var tdReport = document.createElement('td');
        tdReport.innerHTML = '<a class="rlink" href="reports/' + encodeURI(r.folder) + '/index.html">View Report &rarr;</a>';
        tr.appendChild(tdReport);

        /* CI links */
        var tdCI = document.createElement('td');
        var ciParts = [];
        if (r.pipelineUrl) {
          ciParts.push('<a class="ci" href="' + esc(r.pipelineUrl) + '" target="_blank">pipeline</a>');
        }
        if (r.jobUrl) {
          ciParts.push('<a class="ci" href="' + esc(r.jobUrl) + '" target="_blank">job</a>');
        }
        tdCI.innerHTML = ciParts.length ? ciParts.join(' | ') : '-';
        tr.appendChild(tdCI);

        return tr;
      }

      /* â”€â”€â”€ Populate filter dropdowns â”€â”€â”€ */
      function populateSelect(sel, values) {
        var current = sel.value;
        while (sel.options.length > 1) sel.remove(1);
        Array.from(values).sort().forEach(function (v) {
          var o = document.createElement('option');
          o.value = v; o.textContent = v; sel.appendChild(o);
        });
        sel.value = current;
      }

      function refreshDropdowns() {
        var envs = new Set(), jobs = new Set();
        allReports.forEach(function (r) {
          if (r.environment) envs.add(r.environment);
          if (r.job) jobs.add(r.job);
        });
        populateSelect(filterEnv, envs);
        populateSelect(filterJob, jobs);
      }

      /* â”€â”€â”€ Filter logic â”€â”€â”€ */
      function applyFilters() {
        var q = searchInput.value.toLowerCase().trim();
        var env = filterEnv.value;
        var job = filterJob.value;
        var status = filterStatus.value;
        var visible = 0;

        rows.forEach(function (row) {
          var show = true;
          if (q) {
            var text = row.textContent.toLowerCase();
            q.split(/\s+/).forEach(function (word) {
              if (!text.includes(word)) show = false;
            });
          }
          if (env && row.dataset.env !== env) show = false;
          if (job && row.dataset.job !== job) show = false;
          if (status === 'fail' && row.dataset.fail !== '1') show = false;
          if (status === 'pass' && row.dataset.fail === '1') show = false;
          row.classList.toggle('hidden', !show);
          if (show) visible++;
        });

        rowCount.textContent = visible + ' / ' + rows.length + ' reports';
      }

      /* â”€â”€â”€ Column sorting â”€â”€â”€ */
      var sortCol = -1, sortAsc = true;
      table.querySelectorAll('thead th[data-col]').forEach(function (th) {
        var col = parseInt(th.dataset.col);
        if (col > 4) return;
        th.addEventListener('click', function () {
          if (sortCol === col) { sortAsc = !sortAsc; } else { sortCol = col; sortAsc = col === 0 ? false : true; }
          table.querySelectorAll('thead th').forEach(function (h) { h.classList.remove('sorted'); });
          th.classList.add('sorted');
          th.querySelector('.sort-arrow').textContent = sortAsc ? 'â–²' : 'â–¼';
          rows.sort(function (a, b) {
            var at = a.children[col].textContent.trim().toLowerCase();
            var bt = b.children[col].textContent.trim().toLowerCase();
            if (at < bt) return sortAsc ? -1 : 1;
            if (at > bt) return sortAsc ? 1 : -1;
            return 0;
          });
          rows.forEach(function (r) { tbody.appendChild(r); });
        });
      });

      /* â”€â”€â”€ Event listeners â”€â”€â”€ */
      searchInput.addEventListener('input', applyFilters);
      filterEnv.addEventListener('change', applyFilters);
      filterJob.addEventListener('change', applyFilters);
      filterStatus.addEventListener('change', applyFilters);
      btnReset.addEventListener('click', function () {
        searchInput.value = ''; filterEnv.value = ''; filterJob.value = ''; filterStatus.value = '';
        applyFilters();
      });

      /* â”€â”€â”€ Keyboard shortcuts: / to focus, Escape to clear â”€â”€â”€ */
      document.addEventListener('keydown', function (e) {
        if (e.key === '/' && document.activeElement !== searchInput) { e.preventDefault(); searchInput.focus(); }
        if (e.key === 'Escape') {
          searchInput.blur(); searchInput.value = '';
          filterEnv.value = ''; filterJob.value = ''; filterStatus.value = '';
          applyFilters();
        }
      });

      /* â”€â”€â”€ Show error â”€â”€â”€ */
      function showError(msg) {
        loadingEl.innerHTML = '<div class="error-msg">' + esc(msg) + '</div>';
      }

      /* â”€â”€â”€ Fetch manifest.json and render table â”€â”€â”€ */
      fetch('reports/manifest.json?_=' + Date.now())
        .then(function (res) {
          if (!res.ok) throw new Error('Failed to load manifest.json (HTTP ' + res.status + ')');
          return res.json();
        })
        .then(function (data) {
          loadingEl.style.display = 'none';
          allReports = data;

          /* Sort descending by timestamp (newest first) */
          allReports.sort(function (a, b) {
            return (b.timestamp || '').localeCompare(a.timestamp || '');
          });

          /* Build all rows in a document fragment for performance */
          var fragment = document.createDocumentFragment();
          allReports.forEach(function (report) {
            var tr = buildRow(report);
            rows.push(tr);
            fragment.appendChild(tr);
          });
          tbody.appendChild(fragment);

          /* Empty state */
          if (rows.length === 0) {
            var emptyTr = document.createElement('tr');
            emptyTr.className = 'empty-row';
            emptyTr.innerHTML = '<td colspan="7">No reports found</td>';
            tbody.appendChild(emptyTr);
          }

          /* Populate filter dropdowns */
          refreshDropdowns();

          /* Apply URL params if present: ?env=xxx&job=xxx&status=xxx&q=xxx */
          var params = new URLSearchParams(window.location.search);
          if (params.get('env')) filterEnv.value = params.get('env');
          if (params.get('job')) filterJob.value = params.get('job');
          if (params.get('status')) filterStatus.value = params.get('status');
          if (params.get('q')) searchInput.value = params.get('q');

          /* Initial filter pass */
          applyFilters();

          /* Footer */
          footerEl.textContent = allReports.length + ' reports loaded dynamically from manifest.json';
        })
        .catch(function (err) {
          showError('Could not load reports: ' + err.message);
          console.error('[Allure Index]', err);
        });
    })();
  </script>

  <!-- Stats Overview â€” 4 mini SVG charts (no external lib) -->
  <script>
    (function () {
      var PC = { browser: '#1565c0', android: '#2e7d32', ios: '#ef6c00', other: '#757575' };
      var EC = { sandbox: '#7b1fa2', staging: '#1565c0', flux: '#ef6c00', local: '#2e7d32', unknown: '#757575' };

      fetch('stats-history.json?_=' + Date.now())
        .then(function (r) { return r.ok ? r.json() : null; })
        .then(function (data) {
          if (!data || !data.entries || !data.entries.length) return;

          var bar = document.getElementById('statsBar');
          bar.style.display = '';
          var entries = data.entries;

          function computeStats(days) {
            var cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            var cutoffStr = cutoff.toISOString().slice(0, 10);
            var runs = 0, passed = 0, failed = 0;
            entries.forEach(function (e) {
              if (e.date >= cutoffStr) {
                runs += e.totals.runs;
                passed += e.totals.passed;
                failed += e.totals.failed;
              }
            });
            var total = passed + failed;
            var rate = total > 0 ? Math.round(passed / total * 100) : 0;
            return { runs: runs, rate: rate };
          }

          var s7 = computeStats(7);
          var s30 = computeStats(30);
          document.getElementById('sRuns7d').textContent = s7.runs;
          document.getElementById('sPass7d').textContent = s7.rate + '%';
          document.getElementById('sRuns30d').textContent = s30.runs;
          document.getElementById('sPass30d').textContent = s30.rate + '%';

          var last14 = entries.slice(-14);
          if (last14.length > 0) {
            document.getElementById('miniDateRange').textContent =
              last14[0].date + ' â†’ ' + last14[last14.length - 1].date;
            renderMiniCharts(last14);
          }

          /* Toggle */
          var toggle = document.getElementById('statsToggle');
          var body = document.getElementById('statsBody');
          var btn = document.getElementById('statsExpandBtn');
          btn.textContent = 'â–²';
          toggle.addEventListener('click', function () {
            var open = body.classList.toggle('open');
            btn.textContent = open ? 'â–²' : 'â–¼';
          });
        })
        .catch(function () { });

      /* â”€â”€â”€ Collect keys â”€â”€â”€ */
      function collectKeys(entries, field) {
        var keys = {};
        entries.forEach(function (e) {
          Object.keys(e[field] || {}).forEach(function (k) { keys[k] = true; });
        });
        return Object.keys(keys).sort();
      }

      /* â”€â”€â”€ Shared SVG constants â”€â”€â”€ */
      var W = 200, H = 65, pL = 2, pR = 2, pT = 2, pB = 12;
      var cW = W - pL - pR, cH = H - pT - pB;

      function svgOpen() { return '<svg viewBox="0 0 ' + W + ' ' + H + '" xmlns="http://www.w3.org/2000/svg" style="font-family:sans-serif">'; }

      function dateLabels(entries) {
        var svg = [];
        var n = entries.length;
        [0, Math.floor(n / 2), n - 1].forEach(function (idx) {
          if (idx >= n) return;
          var x = pL + (idx + 0.5) * (cW / n);
          svg.push('<text x="' + x + '" y="' + (H - 1) + '" text-anchor="middle" fill="#bbb" font-size="6">' + entries[idx].date.slice(5) + '</text>');
        });
        return svg.join('');
      }

      /* â”€â”€â”€ Stacked bar chart â”€â”€â”€ */
      function renderStackedBars(containerId, entries, field, colors) {
        var keys = collectKeys(entries, field);
        var maxVal = 0;
        entries.forEach(function (e) {
          var sum = 0;
          keys.forEach(function (k) { sum += (e[field][k] || {}).runs || 0; });
          if (sum > maxVal) maxVal = sum;
        });
        if (maxVal === 0) maxVal = 1;
        var n = entries.length;
        var barW = cW / n;
        var gap = barW * 0.2;
        var bw = barW - gap;

        var svg = [svgOpen()];
        entries.forEach(function (e, i) {
          var x = pL + i * barW + gap / 2;
          var yBase = pT + cH;
          var parts = [];
          keys.forEach(function (k) {
            var val = (e[field][k] || {}).runs || 0;
            var h = (val / maxVal) * cH;
            if (h > 0) parts.push({ k: k, h: h, val: val });
          });
          var title = e.date;
          keys.forEach(function (k) { title += '  ' + k + ': ' + ((e[field][k] || {}).runs || 0); });
          svg.push('<g class="bar-group">');
          svg.push('<rect x="' + (pL + i * barW) + '" y="' + pT + '" width="' + barW + '" height="' + cH + '" fill="transparent"><title>' + title + '</title></rect>');
          var offset = 0;
          parts.forEach(function (p) {
            svg.push('<rect x="' + x + '" y="' + (yBase - offset - p.h) + '" width="' + bw + '" height="' + p.h + '" fill="' + (colors[p.k] || '#999') + '" rx="0.8"><title>' + title + '</title></rect>');
            offset += p.h;
          });
          svg.push('</g>');
        });
        svg.push(dateLabels(entries));
        svg.push('</svg>');
        document.getElementById(containerId).innerHTML = svg.join('');
      }

      /* â”€â”€â”€ Line chart â”€â”€â”€ */
      function renderLine(containerId, entries, valueFn, color, unit) {
        var values = entries.map(valueFn);
        var nums = values.filter(function (v) { return v !== null; });
        var maxV = nums.length > 0 ? Math.max.apply(null, nums) : 1;
        var minV = nums.length > 0 ? Math.min.apply(null, nums) : 0;
        if (maxV === minV) { maxV += 1; minV = Math.max(0, minV - 1); }
        var range = maxV - minV;
        var n = entries.length;
        var stepX = cW / Math.max(n - 1, 1);

        var svg = [svgOpen()];
        /* Grid */
        for (var g = 0; g <= 2; g++) {
          var yg = pT + cH - (g / 2) * cH;
          svg.push('<line x1="' + pL + '" y1="' + yg + '" x2="' + (W - pR) + '" y2="' + yg + '" stroke="#eee" stroke-width="0.4"/>');
        }
        /* Y labels */
        svg.push('<text x="' + pL + '" y="' + (pT + 5) + '" fill="#bbb" font-size="5.5">' + Math.round(maxV) + (unit || '') + '</text>');
        svg.push('<text x="' + pL + '" y="' + (pT + cH) + '" fill="#bbb" font-size="5.5">' + Math.round(minV) + (unit || '') + '</text>');
        /* Points */
        var pts = [];
        values.forEach(function (v, i) {
          if (v === null) return;
          var x = pL + i * stepX;
          var y = pT + cH - ((v - minV) / range) * cH;
          pts.push({ x: x, y: y, title: entries[i].date + ': ' + v + (unit || '') });
        });
        if (pts.length > 1) {
          var lineStr = pts.map(function (p) { return p.x + ',' + p.y; }).join(' ');
          var areaStr = pts[0].x + ',' + (pT + cH) + ' ' + lineStr + ' ' + pts[pts.length - 1].x + ',' + (pT + cH);
          svg.push('<polygon points="' + areaStr + '" fill="' + color + '" fill-opacity="0.12"/>');
          svg.push('<polyline points="' + lineStr + '" fill="none" stroke="' + color + '" stroke-width="1.5" stroke-linejoin="round"/>');
        }
        pts.forEach(function (p) {
          svg.push('<circle cx="' + p.x + '" cy="' + p.y + '" r="1.8" fill="' + color + '"><title>' + p.title + '</title></circle>');
        });
        svg.push(dateLabels(entries));
        svg.push('</svg>');
        document.getElementById(containerId).innerHTML = svg.join('');
      }

      /* â”€â”€â”€ Build legend â”€â”€â”€ */
      function buildLegend(entries) {
        var legendEl = document.getElementById('miniLegend');
        var items = [];
        collectKeys(entries, 'platforms').forEach(function (p) {
          items.push('<span><i class="ml-dot" style="background:' + (PC[p] || '#999') + '"></i>' + p + '</span>');
        });
        items.push('<span style="margin-left:4px;border-left:1px solid #ddd;padding-left:6px"></span>');
        collectKeys(entries, 'environments').forEach(function (e) {
          items.push('<span><i class="ml-dot" style="background:' + (EC[e] || '#999') + '"></i>' + e + '</span>');
        });
        legendEl.innerHTML = items.join('');
      }

      /* â”€â”€â”€ Render all 4 â”€â”€â”€ */
      function renderMiniCharts(entries) {
        renderStackedBars('miniPlatformRuns', entries, 'platforms', PC);
        renderStackedBars('miniEnvRuns', entries, 'environments', EC);
        renderLine('miniPassRate', entries, function (e) {
          var t = e.totals.passed + e.totals.failed;
          return t > 0 ? Math.round(e.totals.passed / t * 100) : null;
        }, '#1565c0', '%');
        renderLine('miniAvgTests', entries, function (e) {
          return e.totals.runs > 0 ? Math.round((e.totals.passed + e.totals.failed) / e.totals.runs * 10) / 10 : null;
        }, '#795548', '');
        buildLegend(entries);
      }
    })();
  </script>
</body>

</html>