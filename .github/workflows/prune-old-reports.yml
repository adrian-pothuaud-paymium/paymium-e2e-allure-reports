# Prune old Allure reports (>10 days) to keep the repo lean.
# Keeps allure-history/ (trend data) and all non-report files intact.
# Runs nightly + manual trigger. Squashes history to 1 commit after cleanup.
name: Prune old reports

on:
  schedule:
    # Every day at 03:00 UTC
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      retention_days:
        description: "Delete reports older than N days"
        required: false
        default: "10"
      dry_run:
        description: "Dry run (only list, don't delete)"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: prune
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  prune:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for orphan squash

      - name: Setup Node.js (for stats history)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Capture stats history (before pruning)
        run: |
          echo "Capturing stats from current manifest before pruning..."
          if [ -f "reports/manifest.json" ]; then
            node update-stats-history.js || echo "Warning: stats capture failed (non-blocking)"
          else
            echo "No manifest.json yet, generating first..."
            sh generate-manifest.sh
          fi

      - name: Prune old reports
        id: prune
        run: |
          set -e

          RETENTION_DAYS="${{ github.event.inputs.retention_days || '10' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          CUTOFF_DATE=$(date -u -d "-${RETENTION_DAYS} days" +"%Y-%m-%d" 2>/dev/null || date -u -v-${RETENTION_DAYS}d +"%Y-%m-%d")

          echo "Retention: ${RETENTION_DAYS} days"
          echo "Cutoff date: ${CUTOFF_DATE} (reports before this will be deleted)"
          echo "Dry run: ${DRY_RUN}"
          echo ""

          DELETED=0
          KEPT=0
          FREED_MB=0

          if [ ! -d "reports" ]; then
            echo "No reports/ directory found — nothing to prune."
            echo "deleted=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          for report_dir in reports/*/; do
            [ -d "${report_dir}" ] || continue
            dir_name=$(basename "${report_dir}")

            # Extract date from folder name (format: YYYY-MM-DD_HHMMSS__...)
            REPORT_DATE=$(echo "${dir_name}" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}' || true)

            if [ -z "${REPORT_DATE}" ]; then
              echo "  SKIP (no date): ${dir_name}"
              KEPT=$((KEPT + 1))
              continue
            fi

            if [ "${REPORT_DATE}" \< "${CUTOFF_DATE}" ]; then
              SIZE_MB=$(du -sm "${report_dir}" 2>/dev/null | cut -f1)
              if [ "${DRY_RUN}" = "true" ]; then
                echo "  [DRY RUN] Would delete: ${dir_name} (${SIZE_MB}MB, from ${REPORT_DATE})"
              else
                echo "  DELETE: ${dir_name} (${SIZE_MB}MB, from ${REPORT_DATE})"
                rm -rf "${report_dir}"
              fi
              DELETED=$((DELETED + 1))
              FREED_MB=$((FREED_MB + SIZE_MB))
            else
              echo "  KEEP: ${dir_name} (from ${REPORT_DATE})"
              KEPT=$((KEPT + 1))
            fi
          done

          echo ""
          echo "========================================"
          echo "  Pruning summary"
          echo "========================================"
          echo "  Deleted : ${DELETED} reports (~${FREED_MB}MB)"
          echo "  Kept    : ${KEPT} reports"
          echo "  Cutoff  : ${CUTOFF_DATE}"
          echo "========================================"

          echo "deleted=${DELETED}" >> "$GITHUB_OUTPUT"
          echo "freed_mb=${FREED_MB}" >> "$GITHUB_OUTPUT"

      - name: Regenerate manifest
        if: steps.prune.outputs.deleted != '0' && github.event.inputs.dry_run != 'true'
        run: |
          echo "Regenerating manifest.json after pruning..."
          sh generate-manifest.sh

      - name: Commit changes
        if: steps.prune.outputs.deleted != '0' && github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "prune: removed ${{ steps.prune.outputs.deleted }} old reports (~${{ steps.prune.outputs.freed_mb }}MB freed)"

      - name: Squash git history (reduce repo size)
        if: steps.prune.outputs.deleted != '0' && github.event.inputs.dry_run != 'true'
        run: |
          echo "Squashing git history to a single commit..."

          # Save current tree state
          git checkout --orphan fresh-main

          # Re-add everything (already committed above, orphan branch has clean index)
          git add -A
          git commit -m "pruned repo — $(date -u +%Y-%m-%d) — single-commit history"

          # Replace main
          git branch -D main
          git branch -m main

          # Clean up old objects
          git gc --aggressive --prune=now

          # Force push (replaces all history with 1 commit)
          git push origin main --force

          FINAL_SIZE=$(du -sh . --exclude=.git 2>/dev/null | cut -f1 || du -sh . | cut -f1)
          echo "Repo content size after squash: ${FINAL_SIZE}"

  # Re-deploy pages after prune (the push triggers deploy-pages.yml,
  # but force-push might not — so we do it explicitly here)
  deploy-after-prune:
    needs: prune
    if: needs.prune.outputs.deleted != '0' && github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
